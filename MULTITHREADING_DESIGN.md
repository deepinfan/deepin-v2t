# 多线程并行处理设计

## 当前架构

```
音频输入 (32ms/帧)
  ↓
VAD 处理 (~5ms)
  ↓
ASR 处理 (~20ms)
  ↓
输出
```

**总延迟**: ~25ms/帧（串行）

## 目标架构

```
音频输入 (32ms/帧)
  ↓
  ├─→ VAD 线程 (~5ms)  ─→ VAD 结果队列
  │                          ↓
  └─→ ASR 线程 (~20ms) ←─ 音频队列
                             ↓
                        ASR 结果队列
```

**目标延迟**: ~20ms/帧（并行，取最大值）

## 实现方案

### 方案 A: 简单并行（推荐）
- VAD 和 ASR 在不同线程
- 使用 channel 传递数据
- 实现简单，风险低

### 方案 B: 流水线并行
- 多个 ASR 线程并行处理不同帧
- 复杂度高，收益有限

**选择**: 方案 A

## 数据流

```rust
// 主线程
audio_input → vad_tx (channel)
           → asr_tx (channel)

// VAD 线程
vad_rx → VAD 处理 → vad_result_tx

// ASR 线程
asr_rx → ASR 处理 → asr_result_tx

// 主线程
vad_result_rx + asr_result_rx → 合并结果
```

## 同步策略

1. **VAD 优先**: VAD 结果决定是否启动 ASR
2. **异步 ASR**: ASR 可以滞后几帧
3. **结果合并**: 主线程合并 VAD 和 ASR 结果

## 风险评估

- ✅ 低风险：VAD 和 ASR 本身无状态依赖
- ⚠️ 中风险：需要处理线程同步
- ⚠️ 中风险：需要处理结果顺序

## 预期收益

- 延迟降低：25ms → 20ms（20%）
- CPU 利用率：单核 50% → 双核 30%+30%
- 吞吐量提升：30%

## 实现复杂度

- 代码量：~200 行
- 测试难度：中
- 维护成本：中

## 决策

考虑到：
1. 收益有限（20% 延迟改善）
2. 复杂度较高
3. 当前延迟已经可接受（25ms）

**建议**: 暂缓实现，优先验证阶段1效果。

如果用户反馈延迟仍然明显，再实现多线程并行。
