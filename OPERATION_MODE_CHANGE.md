# V-Input 操作模式对比

## 修改前：Press-to-Talk（按住说话）

**操作方式**：
1. 按下空格键 → 开始录音
2. 保持按住空格键 → 持续录音
3. 松开空格键 → 停止录音并识别

**问题**：
- ❌ 需要一直按住空格键，手很累
- ❌ 键盘重复事件导致多次触发
- ❌ 说长句子时容易松手
- ❌ 不适合长时间输入

**适用场景**：
- 短句快速输入
- 类似对讲机操作

---

## 修改后：Push-to-Toggle（按键切换）✅

**操作方式**：
1. 按一下空格键 → 开始录音
2. 说话（可以很长）
3. 再按一下空格键 → 停止录音并识别

**优点**：
- ✅ 不需要一直按住，手部更轻松
- ✅ 可以说更长的句子
- ✅ 自动避免键盘重复问题（使用状态标志）
- ✅ 操作更直观（像录音软件的开始/停止按钮）
- ✅ 录音中可以思考，不用担心松手

**适用场景**：
- 长句子输入
- 连续语音输入
- 日常使用

---

## 代码改动

### 修改前（vinput_engine.cpp）
```cpp
if (keyEvent.isRelease()) {
    // 松开空格键：停止录音
    stopRecording();
} else {
    // 按下空格键：开始录音
    startRecording();
}
```

### 修改后（vinput_engine.cpp）
```cpp
// 只处理按下事件，忽略释放事件
if (keyEvent.isRelease()) {
    return;  // 忽略释放
}

// 按下空格键：切换录音状态
if (is_recording_) {
    stopRecording();  // 已录音 → 停止
} else {
    startRecording(); // 未录音 → 开始
}
```

---

## 技术细节

### 状态管理
使用 `is_recording_` 布尔标志跟踪录音状态：
- `false` → `true`：开始录音
- `true` → `false`：停止录音

### 键盘重复处理
**自动解决**：由于只在 `!is_recording_` 时才开始录音，重复的按下事件会被自动忽略。

### 用户体验
- 第一次按空格：显示 "🎤 录音中..."
- 第二次按空格：显示 "⏸️ 处理中..."
- 识别完成后：提交文本到应用

---

## 测试计划

1. **基本功能**
   - [ ] 按一下空格，日志显示 "开始录音"
   - [ ] 再按一下空格，日志显示 "停止录音并识别"
   - [ ] 识别结果正确输入到编辑器

2. **连续输入**
   - [ ] 第一句：空格→说话→空格（识别）
   - [ ] 第二句：空格→说话→空格（识别）
   - [ ] 两次输入互不干扰

3. **长句子**
   - [ ] 录音超过 5 秒
   - [ ] 识别结果完整

4. **错误处理**
   - [ ] 录音中切换输入法，自动停止
   - [ ] 失活时正在录音，自动停止

---

## 升级路径

**从 Press-to-Talk 升级到 Push-to-Toggle**：

```bash
# 1. 停止 Fcitx5
killall fcitx5

# 2. 安装新插件
bash /tmp/install_toggle_mode.sh

# 3. 测试新模式
# 打开编辑器，按一下空格→说话→再按空格
```

**无需额外配置**，操作方式自动改变。

---

*修改时间：2026-02-14*
*影响文件：fcitx5-vinput/src/vinput_engine.cpp*
