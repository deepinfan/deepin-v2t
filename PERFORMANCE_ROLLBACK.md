# 性能优化回滚报告

## 问题描述

用户反馈在实施阶段1性能优化后出现以下问题：
1. ❌ 逗号没有正常插入
2. ❌ 有重复字符
3. ❌ 识别准确度下降

## 回滚内容

### 已回滚的优化

1. **懒加载机制** - 完全回滚
   - `StreamingPipeline.asr_recognizer`: `Option<OnlineRecognizer>` → `OnlineRecognizer`
   - 删除 `ensure_asr_loaded()` 方法
   - 删除 `asr_loaded` 标志
   - 恢复启动时立即加载 ASR

2. **模型预热** - 完全回滚
   - 删除 `OnlineRecognizer::warmup()` 方法
   - 不再执行 dummy 推理

### 保留的优化

1. **INT8 量化模型** - 保留
   - 继续使用 `encoder-epoch-99-avg-1.int8.onnx` 等
   - 模型大小：190MB vs 342MB (FP32)
   - 推理速度更快

2. **标点配置调整** - 保留
   - `pause_ratio`: 3.5 → 2.0
   - `min_tokens`: 5 → 3
   - 更容易触发逗号插入

## 回滚原因分析

### 懒加载的问题

懒加载可能导致：
- ASR 流初始化时机不当
- Pre-roll 音频处理异常
- 首次识别状态不稳定

### 模型预热的问题

预热逻辑可能：
- 干扰正常识别流程
- 影响流式解码状态
- 导致 Token 时间戳不准确

## 当前状态

### 代码变更
- ✅ `vinput-core/src/asr/recognizer.rs` - 删除 warmup，保留 INT8
- ✅ `vinput-core/src/streaming/pipeline.rs` - 恢复立即加载 ASR
- ✅ `~/.config/vinput/config.toml` - 调整标点配置

### 编译状态
- ✅ 编译成功
- ⏳ 待安装测试

## 下一步

1. 安装并测试：
   ```bash
   sudo ./install-fcitx5-plugin.sh
   fcitx5 -r
   ```

2. 验证问题是否解决：
   - 逗号是否正常插入
   - 是否还有重复字符
   - 识别准确度是否恢复

3. 如果问题仍存在：
   - 启用调试日志分析
   - 考虑回滚 INT8 模型
   - 检查标点引擎逻辑

## 性能影响

回滚后的性能特征：
- 冷启动时间：~5s（加载 ASR 模型）
- 首次推理延迟：~50ms
- 内存占用（启动）：~200MB
- 识别准确度：应恢复到优化前水平

## 经验教训

1. **性能优化需要充分测试**
   - 懒加载虽然改善启动时间，但可能影响稳定性
   - 应该先在测试环境验证

2. **逐步优化，分步验证**
   - 不应该同时实施多个优化
   - 每个优化都应该独立测试

3. **保持回滚路径**
   - 优化前应该打 tag 或创建分支
   - 便于快速回滚

---

生成时间: 2026-02-17
