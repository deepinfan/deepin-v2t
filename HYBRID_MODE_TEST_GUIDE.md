# 混合模式流式上屏测试指南

## 安装步骤

```bash
cd /home/deepin/deepin-v2t
./install-hybrid-mode.sh
```

脚本会自动：
1. 编译 Rust 核心库
2. 编译 Fcitx5 插件
3. 安装插件（需要 sudo 密码）
4. 重启 Fcitx5

## 测试场景

### 场景 1：普通文本（无数字）

**测试输入：** "今天天气很好"

**预期效果：**
```
100ms: Preedit 显示 "今" (灰色)
200ms: Preedit 显示 "今天" (灰色)
300ms: 上屏 "今" (黑色)，Preedit 显示 "天天" (灰色)
400ms: 上屏 "天" (黑色)，Preedit 显示 "天气" (灰色)
600ms: 上屏 "天气" (黑色)，Preedit 显示 "很好" (灰色)
1500ms: 清除 Preedit，上屏 "很好。" (黑色)

最终结果：今天天气很好。
```

**观察要点：**
- ✅ 稳定的文字逐步上屏（黑色正常文字）
- ✅ 最后 2 个字保留在 Preedit（灰色预览）
- ✅ 句子结束时清除 Preedit，上屏剩余文字

### 场景 2：纯数字文本

**测试输入：** "三百块钱"

**预期效果：**
```
100ms: Preedit 显示 "三" (灰色)
200ms: Preedit 显示 "三百" (灰色)
300ms: Preedit 显示 "三百块" (灰色)
400ms: Preedit 显示 "三百块钱" (灰色)
1500ms: 清除 Preedit，上屏 "¥300" (黑色)

最终结果：¥300
```

**观察要点：**
- ✅ 检测到中文数字，全部保留在 Preedit
- ✅ 没有任何文字立即上屏
- ✅ 句子结束时应用 ITN，上屏 "¥300"

### 场景 3：混合文本（数字在中间）

**测试输入：** "今天买了三百块"

**预期效果：**
```
100ms: Preedit 显示 "今" (灰色)
200ms: Preedit 显示 "今天" (灰色)
300ms: 上屏 "今" (黑色)，Preedit 显示 "天买" (灰色)
400ms: 上屏 "天" (黑色)，Preedit 显示 "买了" (灰色)
500ms: Preedit 显示 "今天买了三" (灰色) ⚠️ 检测到数字
600ms: Preedit 显示 "今天买了三百" (灰色)
700ms: Preedit 显示 "今天买了三百块" (灰色)
1500ms: 清除 Preedit，上屏 "买了¥300" (黑色)

最终结果：今天买了¥300
```

**观察要点：**
- ✅ 前半部分 "今天" 正常流式上屏
- ✅ 检测到数字后，Preedit 显示完整文本（包括已上屏部分）
- ✅ 句子结束时只上屏剩余部分 "买了¥300"

### 场景 4：小数

**测试输入：** "零点五"

**预期效果：**
```
全部在 Preedit 显示
最终上屏：0.5
```

### 场景 5：多个数字

**测试输入：** "我买了三个苹果和五个橙子"

**预期效果：**
```
全部在 Preedit 显示（因为包含 "三" 和 "五"）
最终上屏：我买了3个苹果和5个橙子
```

## 日志查看

实时查看 Fcitx5 日志：

```bash
journalctl --user -u fcitx5 -f
```

关键日志输出：

```
检测到中文数字，全部保留在 Preedit: [三百块钱]
📝 上屏稳定文本: [今]
📝 上屏稳定文本: [天]
🔔 检测到句子结束，处理最终结果
🎤 识别结果（含智能标点）: [三百块钱。]
📝 开始 ITN 处理...
✏️  ITN 完成: 1 处变更
    '三百块钱' → '¥300'
✅ 最终结果: [¥300。]
📝 上屏剩余文本: [¥300。]
✨ 混合模式上屏完成
```

## 常见问题

### Q1: 看不到 Preedit 灰色文字？

**原因：** 某些应用不支持 Preedit 显示

**解决：** 在支持 Preedit 的应用中测试（如 gedit、Kate、Firefox）

### Q2: 数字没有转换为阿拉伯数字？

**原因：** ITN 可能未正确应用

**检查：**
1. 查看日志确认 ITN 是否执行
2. 确认配置文件中 ITN 模式为 Auto

### Q3: 文字上屏太快或太慢？

**调整：** 修改 `KEEP_LAST_CHARS` 参数

```rust
// vinput-core/src/streaming/pipeline.rs
const KEEP_LAST_CHARS: usize = 2;  // 改为 1 或 3
```

### Q4: "标点" 被误判为数字？

**说明：** 这是已知行为，因为 "点" 字被识别为数字字符

**影响：** 不影响最终结果，ITN 已修复 "标点" 识别问题

## 性能测试

### 延迟测试

测量从说话到上屏的延迟：

```
普通文本（无数字）：
- 第一个字上屏：~300ms
- 后续字上屏：~100ms/字

包含数字文本：
- 全部在 Preedit：实时显示
- 最终上屏：句子结束后 ~100ms
```

### 准确度测试

测试 ITN 转换准确度：

| 输入 | 预期输出 | 实际输出 | 状态 |
|------|---------|---------|------|
| 三百块钱 | ¥300 | ¥300 | ✅ |
| 零点五 | 0.5 | 0.5 | ✅ |
| 一千二百三十四 | 1234 | 1234 | ✅ |
| 今天买了三百块 | 今天买了¥300 | 今天买了¥300 | ✅ |

## 对比测试

### 优化前（等待模式）

```
用户说："今天天气很好"
体验：[说话中...] → [等待 1-2秒] → "今天天气很好。"
感受：❌ 延迟明显，不知道识别了什么
```

### 优化后（混合模式）

```
用户说："今天天气很好"
体验：
  100ms: Preedit "今"
  300ms: 上屏 "今"，Preedit "天天"
  400ms: 上屏 "天"，Preedit "天气"
  600ms: 上屏 "天气"，Preedit "很好"
  1500ms: 上屏 "很好。"

感受：✅ 流畅，有即时反馈，类似拼音输入法
```

## 反馈

如果发现问题，请记录：

1. **测试输入**：说了什么话
2. **预期结果**：应该输出什么
3. **实际结果**：实际输出了什么
4. **日志输出**：相关的日志信息
5. **测试环境**：应用程序名称

提交 Issue 到：https://github.com/deepinfan/deepin-v2t/issues

---

**测试时间：** 2026-02-16
**版本：** v0.2.0 (混合模式)
